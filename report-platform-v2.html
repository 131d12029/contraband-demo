<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>違禁商品通報平台</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  :root {
    --navy: #0a1628;
    --navy-mid: #112240;
    --navy-light: #1a3160;
    --amber: #f5a623;
    --amber-light: #ffd280;
    --red: #e84545;
    --green: #2dce89;
    --orange: #fb6340;
    --gray-muted: #8892a4;
    --gray-border: #1e3050;
    --white: #ffffff;
    --text-primary: #e8edf5;
    --text-secondary: #8892a4;
    --card-bg: #112240;
    --input-bg: #0d1e38;
    --shadow: 0 4px 24px rgba(0,0,0,0.4);
    --radius: 12px;
    --radius-sm: 8px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Noto Sans TC', sans-serif;
    background: var(--navy);
    color: var(--text-primary);
    min-height: 100vh;
    padding-bottom: 80px;
  }

  /* ─── NAVBAR ─── */
  .navbar {
    background: var(--navy-mid);
    border-bottom: 1px solid var(--gray-border);
    padding: 0 24px;
    height: 64px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 100;
    backdrop-filter: blur(8px);
  }
  .navbar-brand {
    display: flex;
    align-items: center;
    gap: 10px;
    text-decoration: none;
  }
  .brand-icon {
    width: 36px; height: 36px;
    background: var(--amber);
    border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    font-size: 18px; color: var(--navy);
  }
  .brand-text {
    font-weight: 900;
    font-size: 16px;
    color: var(--white);
    line-height: 1.2;
  }
  .brand-sub {
    font-size: 10px;
    color: var(--amber);
    font-family: 'Space Mono', monospace;
    letter-spacing: 1px;
  }
  .nav-links {
    display: flex;
    gap: 4px;
    list-style: none;
  }
  .nav-links li a {
    padding: 8px 16px;
    border-radius: var(--radius-sm);
    text-decoration: none;
    color: var(--text-secondary);
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s;
    cursor: pointer;
    display: flex; align-items: center; gap: 6px;
  }
  .nav-links li a:hover { color: var(--white); background: var(--navy-light); }
  .nav-links li a.active { color: var(--amber); background: rgba(245,166,35,0.1); }

  /* ─── BOTTOM TAB (mobile) ─── */
  .bottom-tab {
    display: none;
    position: fixed;
    bottom: 0; left: 0; right: 0;
    background: var(--navy-mid);
    border-top: 1px solid var(--gray-border);
    z-index: 100;
    padding: 8px 0 env(safe-area-inset-bottom);
  }
  .bottom-tab-inner {
    display: flex;
    justify-content: space-around;
  }
  .tab-btn {
    flex: 1;
    display: flex; flex-direction: column; align-items: center;
    gap: 4px;
    padding: 6px 0;
    background: none; border: none;
    color: var(--text-secondary);
    font-size: 10px;
    font-family: 'Noto Sans TC', sans-serif;
    cursor: pointer;
    transition: color 0.2s;
  }
  .tab-btn i { font-size: 20px; }
  .tab-btn.active { color: var(--amber); }

  /* ─── PAGES ─── */
  .page { display: none; animation: fadeIn 0.3s ease; }
  .page.active { display: block; }
  @keyframes fadeIn { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }

  .container { max-width: 1100px; margin: 0 auto; padding: 32px 24px; }

  /* ─── PAGE HEADER ─── */
  .page-header { margin-bottom: 32px; }
  .page-header .label {
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    color: var(--amber);
    letter-spacing: 2px;
    text-transform: uppercase;
    margin-bottom: 8px;
  }
  .page-header h1 { font-size: 28px; font-weight: 900; color: var(--white); }
  .page-header p { color: var(--text-secondary); margin-top: 6px; font-size: 14px; }

  /* ─── CARDS ─── */
  .card {
    background: var(--card-bg);
    border: 1px solid var(--gray-border);
    border-radius: var(--radius);
    padding: 24px;
  }

  /* ─── FORM ─── */
  .step-indicator {
    display: flex;
    align-items: center;
    gap: 0;
    margin-bottom: 32px;
  }
  .step {
    display: flex; align-items: center; gap: 10px;
    flex: 1;
  }
  .step-num {
    width: 32px; height: 32px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-weight: 700; font-size: 13px;
    background: var(--navy-light);
    color: var(--text-secondary);
    border: 2px solid var(--gray-border);
    transition: all 0.3s;
    flex-shrink: 0;
  }
  .step.active .step-num {
    background: var(--amber);
    color: var(--navy);
    border-color: var(--amber);
  }
  .step.done .step-num {
    background: var(--green);
    color: var(--white);
    border-color: var(--green);
  }
  .step-label { font-size: 13px; color: var(--text-secondary); font-weight: 500; }
  .step.active .step-label { color: var(--white); }
  .step-line {
    flex: 1; height: 2px;
    background: var(--gray-border);
    margin: 0 12px;
  }

  .form-section { display: none; }
  .form-section.active { display: block; }

  .form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
  }
  .form-group { display: flex; flex-direction: column; gap: 8px; }
  .form-group.full { grid-column: 1 / -1; }
  .form-group label {
    font-size: 13px;
    font-weight: 700;
    color: var(--text-primary);
    display: flex; align-items: center; gap: 6px;
  }
  .required { color: var(--red); }
  .form-group input,
  .form-group select,
  .form-group textarea {
    background: var(--input-bg);
    border: 1px solid var(--gray-border);
    border-radius: var(--radius-sm);
    padding: 12px 14px;
    color: var(--text-primary);
    font-size: 14px;
    font-family: 'Noto Sans TC', sans-serif;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
    width: 100%;
  }
  .form-group input:focus,
  .form-group select:focus,
  .form-group textarea:focus {
    border-color: var(--amber);
    box-shadow: 0 0 0 3px rgba(245,166,35,0.15);
  }
  .form-group select option { background: var(--navy-mid); }
  .form-group textarea { resize: vertical; min-height: 100px; }

  .checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; }
  .checkbox-item {
    display: flex; align-items: center; gap: 8px;
    background: var(--input-bg);
    border: 1px solid var(--gray-border);
    border-radius: var(--radius-sm);
    padding: 8px 14px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 13px;
  }
  .checkbox-item:hover { border-color: var(--amber); }
  .checkbox-item input { accent-color: var(--amber); }

  .upload-area {
    border: 2px dashed var(--gray-border);
    border-radius: var(--radius);
    padding: 32px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    background: var(--input-bg);
  }
  .upload-area:hover { border-color: var(--amber); background: rgba(245,166,35,0.05); }
  .upload-area i { font-size: 32px; color: var(--amber); margin-bottom: 12px; display: block; }
  .upload-area p { color: var(--text-secondary); font-size: 13px; }
  .upload-area strong { color: var(--text-primary); }

  /* ─── IMAGE PREVIEW WITH DELETE ─── */
  .preview-container {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 10px;
  }
  .preview-item {
    position: relative;
    display: inline-block;
  }
  .preview-item img {
    width: 80px; height: 80px;
    object-fit: cover;
    border-radius: 8px;
    border: 1px solid var(--gray-border);
    display: block;
  }
  .preview-delete {
    position: absolute;
    top: -6px; right: -6px;
    width: 20px; height: 20px;
    background: var(--red);
    color: white;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    font-size: 10px;
    font-weight: 700;
    line-height: 1;
    transition: transform 0.15s, background 0.15s;
    z-index: 2;
  }
  .preview-delete:hover { background: #c0392b; transform: scale(1.15); }

  .anon-toggle {
    display: flex; align-items: center; gap: 12px;
    background: var(--input-bg);
    border: 1px solid var(--gray-border);
    border-radius: var(--radius-sm);
    padding: 14px;
    cursor: pointer;
  }
  .toggle-switch {
    width: 44px; height: 24px;
    background: var(--gray-border);
    border-radius: 12px;
    position: relative;
    transition: background 0.2s;
    flex-shrink: 0;
  }
  .toggle-switch.on { background: var(--amber); }
  .toggle-switch::after {
    content: '';
    position: absolute;
    width: 18px; height: 18px;
    background: white;
    border-radius: 50%;
    top: 3px; left: 3px;
    transition: left 0.2s;
  }
  .toggle-switch.on::after { left: 23px; }

  .btn {
    padding: 12px 28px;
    border-radius: var(--radius-sm);
    border: none;
    font-size: 14px;
    font-weight: 700;
    font-family: 'Noto Sans TC', sans-serif;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex; align-items: center; gap: 8px;
  }
  .btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none !important;
  }
  .btn-primary {
    background: var(--amber);
    color: var(--navy);
  }
  .btn-primary:not(:disabled):hover { background: var(--amber-light); transform: translateY(-1px); }
  .btn-secondary {
    background: transparent;
    color: var(--text-secondary);
    border: 1px solid var(--gray-border);
  }
  .btn-secondary:not(:disabled):hover { color: var(--white); border-color: var(--white); }

  /* ─── LOADING SPINNER ─── */
  @keyframes spin { to { transform: rotate(360deg); } }
  .fa-spin-custom { animation: spin 0.8s linear infinite; }

  .form-actions {
    display: flex; justify-content: flex-end; gap: 12px;
    margin-top: 28px;
    padding-top: 24px;
    border-top: 1px solid var(--gray-border);
  }

  /* URL preview */
  .platform-preview {
    display: none;
    align-items: center;
    gap: 10px;
    background: rgba(245,166,35,0.08);
    border: 1px solid rgba(245,166,35,0.3);
    border-radius: var(--radius-sm);
    padding: 10px 14px;
    margin-top: 8px;
    font-size: 13px;
  }
  .platform-preview.show { display: flex; }
  .platform-badge {
    background: var(--amber);
    color: var(--navy);
    border-radius: 4px;
    padding: 2px 8px;
    font-weight: 700;
    font-size: 12px;
  }

  /* success card */
  .success-card {
    text-align: center;
    padding: 48px 24px;
  }
  .success-icon {
    width: 72px; height: 72px;
    background: rgba(45,206,137,0.15);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    margin: 0 auto 20px;
    font-size: 32px; color: var(--green);
  }
  .report-id {
    font-family: 'Space Mono', monospace;
    font-size: 22px;
    color: var(--amber);
    letter-spacing: 3px;
    margin: 16px 0;
  }

  /* ─── HISTORY ─── */
  .filter-bar {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 24px;
    align-items: center;
  }
  .search-box {
    flex: 1;
    min-width: 200px;
    position: relative;
  }
  .search-box input {
    background: var(--card-bg);
    border: 1px solid var(--gray-border);
    border-radius: var(--radius-sm);
    padding: 10px 14px 10px 38px;
    color: var(--text-primary);
    font-size: 14px;
    font-family: 'Noto Sans TC', sans-serif;
    outline: none;
    width: 100%;
    transition: border-color 0.2s;
  }
  .search-box input:focus { border-color: var(--amber); }
  .search-box i {
    position: absolute; left: 12px; top: 50%;
    transform: translateY(-50%);
    color: var(--text-secondary); font-size: 14px;
  }
  .filter-select {
    background: var(--card-bg);
    border: 1px solid var(--gray-border);
    border-radius: var(--radius-sm);
    padding: 10px 14px;
    color: var(--text-primary);
    font-size: 13px;
    font-family: 'Noto Sans TC', sans-serif;
    outline: none;
    cursor: pointer;
  }
  .filter-select:focus { border-color: var(--amber); }

  .records-count {
    font-size: 13px;
    color: var(--text-secondary);
    margin-bottom: 16px;
  }
  .records-count span { color: var(--amber); font-weight: 700; }

  /* ─── EMPTY STATE ─── */
  .empty-state {
    text-align: center;
    padding: 56px 24px;
    color: var(--text-secondary);
  }
  .empty-state i { font-size: 40px; color: var(--gray-border); margin-bottom: 16px; display: block; }
  .empty-state p { font-size: 14px; }

  .record-card {
    background: var(--card-bg);
    border: 1px solid var(--gray-border);
    border-radius: var(--radius);
    margin-bottom: 12px;
    overflow: hidden;
    transition: border-color 0.2s;
    cursor: pointer;
  }
  .record-card:hover { border-color: rgba(245,166,35,0.4); }
  .record-header {
    padding: 16px 20px;
    display: flex;
    align-items: center;
    gap: 14px;
  }
  .platform-dot {
    width: 38px; height: 38px;
    border-radius: var(--radius-sm);
    display: flex; align-items: center; justify-content: center;
    font-weight: 900; font-size: 12px;
    flex-shrink: 0;
  }
  .record-main { flex: 1; min-width: 0; }
  .record-title {
    font-weight: 700; font-size: 14px;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .record-meta {
    display: flex; gap: 12px; margin-top: 4px;
    flex-wrap: wrap;
  }
  .meta-tag {
    font-size: 11px; color: var(--text-secondary);
    display: flex; align-items: center; gap: 4px;
  }
  .status-badge {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 700;
    flex-shrink: 0;
  }
  .status-pending { background: rgba(138,145,162,0.15); color: #8a91a2; }
  .status-reviewing { background: rgba(251,99,64,0.15); color: var(--orange); }
  .status-done { background: rgba(45,206,137,0.15); color: var(--green); }
  .status-invalid { background: rgba(232,69,69,0.15); color: var(--red); }
  .record-chevron { color: var(--text-secondary); font-size: 14px; transition: transform 0.2s; }
  .record-card.expanded .record-chevron { transform: rotate(180deg); }

  .record-detail {
    display: none;
    padding: 0 20px 20px;
    border-top: 1px solid var(--gray-border);
    animation: fadeIn 0.2s ease;
  }
  .record-card.expanded .record-detail { display: block; }
  .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 16px; }
  .detail-item label { font-size: 11px; color: var(--text-secondary); margin-bottom: 4px; display: block; }
  .detail-item span { font-size: 13px; color: var(--text-primary); }
  .detail-link { color: var(--amber); font-size: 13px; word-break: break-all; }

  .timeline { margin-top: 20px; }
  .timeline-title { font-size: 12px; font-weight: 700; color: var(--text-secondary); margin-bottom: 12px; letter-spacing: 1px; text-transform: uppercase; }
  .timeline-item {
    display: flex; gap: 12px; margin-bottom: 12px;
  }
  .timeline-dot {
    width: 10px; height: 10px;
    border-radius: 50%;
    background: var(--amber);
    margin-top: 4px;
    flex-shrink: 0;
    position: relative;
  }
  .timeline-dot::after {
    content: '';
    position: absolute;
    left: 4px; top: 14px;
    width: 2px; height: calc(100% + 8px);
    background: var(--gray-border);
  }
  .timeline-item:last-child .timeline-dot::after { display: none; }
  .timeline-text { font-size: 13px; }
  .timeline-date { font-size: 11px; color: var(--text-secondary); margin-top: 2px; }

  /* ─── STATS ─── */
  .stats-summary {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    margin-bottom: 28px;
  }
  .stat-card {
    background: var(--card-bg);
    border: 1px solid var(--gray-border);
    border-radius: var(--radius);
    padding: 20px;
    position: relative;
    overflow: hidden;
    transition: transform 0.2s, border-color 0.2s;
  }
  .stat-card:hover { transform: translateY(-2px); border-color: rgba(245,166,35,0.3); }
  .stat-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 3px;
  }
  .stat-card.amber::before { background: var(--amber); }
  .stat-card.green::before { background: var(--green); }
  .stat-card.orange::before { background: var(--orange); }
  .stat-card.red::before { background: var(--red); }
  .stat-icon { font-size: 24px; margin-bottom: 12px; }
  .stat-card.amber .stat-icon { color: var(--amber); }
  .stat-card.green .stat-icon { color: var(--green); }
  .stat-card.orange .stat-icon { color: var(--orange); }
  .stat-card.red .stat-icon { color: var(--red); }
  .stat-value { font-size: 32px; font-weight: 900; color: var(--white); font-family: 'Space Mono', monospace; transition: all 0.4s; }
  .stat-label { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }
  .stat-change { font-size: 11px; margin-top: 8px; }
  .stat-change.up { color: var(--green); }
  .stat-change.down { color: var(--red); }

  .charts-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
  }
  .chart-card {
    background: var(--card-bg);
    border: 1px solid var(--gray-border);
    border-radius: var(--radius);
    padding: 24px;
  }
  .chart-card.full { grid-column: 1 / -1; }
  .chart-title {
    font-size: 14px;
    font-weight: 700;
    color: var(--white);
    margin-bottom: 20px;
    display: flex; align-items: center; justify-content: space-between;
  }
  .chart-subtitle { font-size: 11px; color: var(--text-secondary); font-weight: 400; }
  .chart-wrap { position: relative; height: 220px; }

  /* ─── RWD ─── */
  @media (max-width: 1024px) {
    .stats-summary { grid-template-columns: repeat(2, 1fr); }
    .charts-grid { grid-template-columns: 1fr; }
    .chart-card.full { grid-column: 1; }
  }

  @media (max-width: 768px) {
    .navbar { padding: 0 16px; }
    .nav-links { display: none; }
    .bottom-tab { display: block; }
    body { padding-bottom: 90px; }
    .container { padding: 20px 16px; }
    .form-grid { grid-template-columns: 1fr; }
    .form-group.full { grid-column: 1; }
    .stats-summary { grid-template-columns: repeat(2, 1fr); }
    .detail-grid { grid-template-columns: 1fr; }
    .page-header h1 { font-size: 22px; }
    .filter-bar { flex-direction: column; align-items: stretch; }
    .search-box { min-width: unset; }
  }

  @media (max-width: 480px) {
    .stats-summary { grid-template-columns: 1fr 1fr; gap: 10px; }
    .stat-value { font-size: 24px; }
    .stat-card { padding: 14px; }
    .step-label { display: none; }
    .form-actions { flex-direction: column-reverse; }
    .form-actions .btn { width: 100%; justify-content: center; }
  }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: var(--navy); }
  ::-webkit-scrollbar-thumb { background: var(--navy-light); border-radius: 3px; }
</style>
</head>
<body>

<!-- NAVBAR -->
<nav class="navbar">
  <a class="navbar-brand" href="#">
    <div class="brand-icon"><i class="fas fa-shield-halved"></i></div>
    <div>
      <div class="brand-text">違禁商品通報平台</div>
      <div class="brand-sub">E-COMMERCE REPORT</div>
    </div>
  </a>
  <ul class="nav-links">
    <li><a onclick="showPage('report')" id="nav-report" class="active"><i class="fas fa-flag"></i> 立即通報</a></li>
    <li><a onclick="showPage('history')" id="nav-history"><i class="fas fa-list-ul"></i> 通報紀錄</a></li>
    <li><a onclick="showPage('stats')" id="nav-stats"><i class="fas fa-chart-bar"></i> 統計數據</a></li>
  </ul>
</nav>

<!-- ══════════ PAGE: REPORT ══════════ -->
<div id="page-report" class="page active">
  <div class="container">
    <div class="page-header">
      <div class="label">REPORT / 違規通報</div>
      <h1>通報電商違禁商品</h1>
      <p>發現網路平台販售政府公告禁售商品？請填寫以下資訊協助調查。</p>
    </div>

    <div class="card">
      <!-- Step indicator -->
      <div class="step-indicator">
        <div class="step active" id="step1-indicator">
          <div class="step-num">1</div>
          <div class="step-label">商品與平台資訊</div>
        </div>
        <div class="step-line"></div>
        <div class="step" id="step2-indicator">
          <div class="step-num">2</div>
          <div class="step-label">確認送出</div>
        </div>
      </div>

      <!-- STEP 1 -->
      <div class="form-section active" id="form-step1">
        <div class="form-grid">

          <div class="form-group full">
            <label><i class="fas fa-link"></i> 商品頁面網址 <span class="required">*</span></label>
            <input type="url" id="product-url" placeholder="請貼上商品頁面連結，例如：https://shopee.tw/..." oninput="detectPlatform(this.value)">
            <div class="platform-preview" id="platform-preview">
              <i class="fas fa-check-circle" style="color:var(--green)"></i>
              <span>偵測到平台：</span>
              <span class="platform-badge" id="detected-platform"></span>
              <span id="detected-name" style="color:var(--text-secondary);font-size:12px"></span>
            </div>
          </div>

          <div class="form-group">
            <label><i class="fas fa-store"></i> 電商平台 <span class="required">*</span></label>
            <select id="platform-select">
              <option value="">請選擇平台</option>
              <option value="shopee">蝦皮購物 Shopee</option>
              <option value="pchome">PChome 24h</option>
              <option value="momo">momo 購物網</option>
              <option value="ruten">露天市集</option>
              <option value="yahoo">Yahoo 購物中心</option>
              <option value="rakuten">樂天市場</option>
              <option value="other">其他平台</option>
            </select>
          </div>

          <div class="form-group">
            <label><i class="fas fa-user-tag"></i> 賣家名稱 / ID</label>
            <input type="text" id="seller-id" placeholder="選填，例如：shop_12345">
          </div>

          <div class="form-group">
            <label><i class="fas fa-tag"></i> 商品名稱 <span class="required">*</span></label>
            <input type="text" id="product-name" placeholder="請輸入商品標題">
          </div>

          <div class="form-group">
            <label><i class="fas fa-list"></i> 禁售類別 <span class="required">*</span></label>
            <select id="category-select">
              <option value="">請選擇類別</option>
              <option>未核准藥品或偽藥</option>
              <option>違禁毒品或管制物質</option>
              <option>仿冒品 / 侵權商品</option>
              <option>違規食品添加物</option>
              <option>危險玩具（未符 CNS 標準）</option>
              <option>未申報電磁波產品</option>
              <option>非法槍械或爆裂物</option>
              <option>其他</option>
            </select>
          </div>

          <div class="form-group full">
            <label><i class="fas fa-image"></i> 佐證截圖（最多 3 張）</label>
            <div class="upload-area" onclick="document.getElementById('file-upload').click()">
              <i class="fas fa-cloud-arrow-up"></i>
              <p><strong>點擊或拖曳上傳截圖</strong></p>
              <p>支援 JPG、PNG，每張上限 5MB</p>
            </div>
            <input type="file" id="file-upload" accept="image/*" multiple style="display:none" onchange="previewFiles(this)">
            <div class="preview-container" id="preview-container"></div>
          </div>

          <div class="form-group full">
            <label><i class="fas fa-pen-to-square"></i> 補充說明</label>
            <textarea id="note-field" placeholder="請描述您發現此違規商品的情況，或提供其他相關資訊..."></textarea>
          </div>

          <div class="form-group full">
            <label><i class="fas fa-envelope"></i> 通報人 Email</label>
            <input type="email" id="email-field" placeholder="選填，用於接收通報進度通知">
          </div>
        </div>

        <div class="form-actions">
          <button class="btn btn-primary" onclick="goStep2()">
            下一步：確認送出 <i class="fas fa-arrow-right"></i>
          </button>
        </div>
      </div>

      <!-- STEP 2 -->
      <div class="form-section" id="form-step2">
        <div style="margin-bottom:24px">
          <h3 style="font-size:16px;font-weight:700;margin-bottom:16px;color:var(--white)">請確認以下通報資訊</h3>
          <div id="confirm-content" style="background:var(--input-bg);border-radius:var(--radius-sm);padding:20px;border:1px solid var(--gray-border)"></div>
        </div>
        <div style="background:rgba(245,166,35,0.06);border:1px solid rgba(245,166,35,0.2);border-radius:var(--radius-sm);padding:14px;font-size:13px;color:var(--text-secondary);margin-bottom:24px">
          <i class="fas fa-circle-info" style="color:var(--amber)"></i>
          本通報資料將依《個人資料保護法》處理，僅供主管機關調查使用。
        </div>
        <div class="form-actions">
          <button class="btn btn-secondary" id="btn-back" onclick="goStep1()"><i class="fas fa-arrow-left"></i> 返回修改</button>
          <button class="btn btn-primary" id="btn-submit" onclick="submitReport()"><i class="fas fa-paper-plane"></i> 確認送出通報</button>
        </div>
      </div>

      <!-- SUCCESS -->
      <div class="form-section" id="form-success">
        <div class="success-card">
          <div class="success-icon"><i class="fas fa-check"></i></div>
          <h2 style="font-size:22px;font-weight:900;color:var(--white)">通報已成功送出！</h2>
          <p style="color:var(--text-secondary);margin-top:8px;font-size:14px">您的通報編號為</p>
          <div class="report-id" id="report-id-display">RPT-2024-0021</div>
          <p style="color:var(--text-secondary);font-size:13px;max-width:400px;margin:0 auto">請保存此編號，您可前往「通報紀錄」頁面查詢處理進度</p>
          <div style="display:flex;gap:12px;justify-content:center;margin-top:28px;flex-wrap:wrap">
            <button class="btn btn-secondary" onclick="copyId()"><i class="fas fa-copy"></i> 複製編號</button>
            <button class="btn btn-primary" onclick="showPage('history')"><i class="fas fa-list-ul"></i> 查看通報紀錄</button>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- ══════════ PAGE: HISTORY ══════════ -->
<div id="page-history" class="page">
  <div class="container">
    <div class="page-header">
      <div class="label">HISTORY / 通報紀錄</div>
      <h1>通報案件紀錄</h1>
      <p>所有民眾通報之電商違禁商品紀錄，依最新通報排序。</p>
    </div>

    <div class="filter-bar">
      <div class="search-box">
        <i class="fas fa-search"></i>
        <input type="text" id="filter-search" placeholder="搜尋商品名稱或賣家..." oninput="filterRecords()">
      </div>
      <select class="filter-select" id="filter-platform" onchange="filterRecords()">
        <option value="">所有平台</option>
        <option value="蝦皮購物">蝦皮購物</option>
        <option value="PChome">PChome</option>
        <option value="momo">momo</option>
        <option value="露天市集">露天市集</option>
        <option value="Yahoo 購物">Yahoo 購物</option>
      </select>
      <select class="filter-select" id="filter-category" onchange="filterRecords()">
        <option value="">所有類別</option>
        <option value="未核准藥品或偽藥">未核准藥品或偽藥</option>
        <option value="仿冒品 / 侵權商品">仿冒品</option>
        <option value="違規食品添加物">違規食品添加物</option>
        <option value="危險玩具（未符 CNS 標準）">危險玩具</option>
        <option value="違禁毒品或管制物質">管制物質</option>
        <option value="未申報電磁波產品">電磁波產品</option>
      </select>
      <select class="filter-select" id="filter-status" onchange="filterRecords()">
        <option value="">所有狀態</option>
        <option value="reviewing">審核中</option>
        <option value="done">已處理</option>
        <option value="invalid">不成立</option>
      </select>
    </div>

    <div class="records-count">共找到 <span id="records-count-num">20</span> 筆通報紀錄</div>
    <div id="records-list"></div>
  </div>
</div>

<!-- ══════════ PAGE: STATS ══════════ -->
<div id="page-stats" class="page">
  <div class="container">
    <div class="page-header">
      <div class="label">STATISTICS / 統計數據</div>
      <h1>通報數據總覽</h1>
      <p>即時更新的電商違禁商品通報統計，資料截至今日。</p>
    </div>

    <!-- Summary Cards -->
    <div class="stats-summary">
      <div class="stat-card amber">
        <div class="stat-icon"><i class="fas fa-flag"></i></div>
        <div class="stat-value" id="stat-total">248</div>
        <div class="stat-label">總通報數</div>
        <div class="stat-change up" id="stat-total-sub"><i class="fas fa-arrow-up"></i> 較上月 +18%</div>
      </div>
      <div class="stat-card green">
        <div class="stat-icon"><i class="fas fa-circle-check"></i></div>
        <div class="stat-value" id="stat-done">173</div>
        <div class="stat-label">已處理件數</div>
        <div class="stat-change up" id="stat-done-sub"><i class="fas fa-arrow-up"></i> 處理率 <span id="stat-rate">69.8</span>%</div>
      </div>
      <div class="stat-card orange">
        <div class="stat-icon"><i class="fas fa-hourglass-half"></i></div>
        <div class="stat-value" id="stat-reviewing">41</div>
        <div class="stat-label">審核中</div>
        <div class="stat-change down"><i class="fas fa-arrow-down"></i> 較上月 -3</div>
      </div>
      <div class="stat-card red">
        <div class="stat-icon"><i class="fas fa-clock"></i></div>
        <div class="stat-value">5.2</div>
        <div class="stat-label">平均處理天數</div>
        <div class="stat-change up"><i class="fas fa-arrow-up"></i> 較上月改善 0.8 天</div>
      </div>
    </div>

    <!-- Charts Row 1 -->
    <div class="charts-grid">
      <div class="chart-card full">
        <div class="chart-title">每月通報數量趨勢 <span class="chart-subtitle">近 6 個月</span></div>
        <div class="chart-wrap"><canvas id="trendChart"></canvas></div>
      </div>

      <div class="chart-card">
        <div class="chart-title">各電商平台通報數量 <span class="chart-subtitle">排行</span></div>
        <div class="chart-wrap"><canvas id="platformChart"></canvas></div>
      </div>

      <div class="chart-card">
        <div class="chart-title">禁售類別分布 <span class="chart-subtitle">佔比</span></div>
        <div class="chart-wrap"><canvas id="categoryChart"></canvas></div>
      </div>

      <div class="chart-card full">
        <div class="chart-title">各平台違規樣態分析 <span class="chart-subtitle">堆疊比較</span></div>
        <div class="chart-wrap" style="height:260px"><canvas id="violationChart"></canvas></div>
      </div>
    </div>

  </div>
</div>

<!-- BOTTOM TAB -->
<div class="bottom-tab">
  <div class="bottom-tab-inner">
    <button class="tab-btn active" id="tab-report" onclick="showPage('report')">
      <i class="fas fa-flag"></i> 通報
    </button>
    <button class="tab-btn" id="tab-history" onclick="showPage('history')">
      <i class="fas fa-list-ul"></i> 紀錄
    </button>
    <button class="tab-btn" id="tab-stats" onclick="showPage('stats')">
      <i class="fas fa-chart-bar"></i> 統計
    </button>
  </div>
</div>

<!-- ══════════ SCRIPTS ══════════ -->
<script>
// ─────────────────────────────────
// 1. MOCK DATA + LocalStorage merge
// ─────────────────────────────────
const BASE_RECORDS = [
  { id:"RPT-2024-0020", platform:"蝦皮購物", platformKey:"shopee", product:"快速瘦身減脂膠囊 XX牌", category:"未核准藥品或偽藥", violations:["非法販售","標示不符"], status:"done", date:"2024-12-10", seller:"shopee_health99", url:"https://shopee.tw/...", note:"商品聲稱可快速減重，無衛福部核准字號", timeline:[{text:"通報收到",date:"2024-12-10"},{text:"審核中，已轉交稽查",date:"2024-12-11"},{text:"確認違規，已通知平台下架",date:"2024-12-14"}] },
  { id:"RPT-2024-0019", platform:"PChome", platformKey:"pchome", product:"美國進口麻黃素飲品", category:"未核准藥品或偽藥", violations:["來源不明"], status:"reviewing", date:"2024-12-09", seller:"PC_sports_shop", url:"https://24h.pchome.com.tw/...", note:"標示全英文，無中文說明書", timeline:[{text:"通報收到",date:"2024-12-09"},{text:"已進入審核",date:"2024-12-10"}] },
  { id:"RPT-2024-0018", platform:"momo", platformKey:"momo", product:"LV 精品皮包（1:1高仿）", category:"仿冒品 / 侵權商品", violations:["仿冒或侵權"], status:"done", date:"2024-12-08", seller:"momo_luxury88", url:"https://www.momoshop.com.tw/...", note:"賣家明確標示1:1仿製", timeline:[{text:"通報收到",date:"2024-12-08"},{text:"確認違規，已下架處理",date:"2024-12-09"}] },
  { id:"RPT-2024-0017", platform:"蝦皮購物", platformKey:"shopee", product:"含塑化劑兒童積木組", category:"危險玩具（未符 CNS 標準）", violations:["非法販售","標示不符"], status:"pending", date:"2024-12-07", seller:"toy_world_tw", url:"https://shopee.tw/...", note:"塑膠玩具無 CNS 安全標章", timeline:[{text:"通報收到，等待審核",date:"2024-12-07"}] },
  { id:"RPT-2024-0016", platform:"露天市集", platformKey:"ruten", product:"含禁用色素食用染料", category:"違規食品添加物", violations:["非法販售"], status:"done", date:"2024-12-05", seller:"ruten_food_store", url:"https://www.ruten.com.tw/...", note:"含歐盟禁用食用色素", timeline:[{text:"通報收到",date:"2024-12-05"},{text:"稽查確認",date:"2024-12-07"},{text:"已處理完畢",date:"2024-12-10"}] },
  { id:"RPT-2024-0015", platform:"Yahoo 購物", platformKey:"yahoo", product:"強效安眠藥（無處方）", category:"未核准藥品或偽藥", violations:["非法販售","來源不明"], status:"reviewing", date:"2024-12-04", seller:"yahoo_medi_shop", url:"https://tw.buy.yahoo.com/...", note:"宣稱可治失眠，疑似含管制成分", timeline:[{text:"通報收到",date:"2024-12-04"},{text:"轉交藥管局審查",date:"2024-12-05"}] },
  { id:"RPT-2024-0014", platform:"蝦皮購物", platformKey:"shopee", product:"韓國代購 BTS 周邊（無授權）", category:"仿冒品 / 侵權商品", violations:["仿冒或侵權"], status:"invalid", date:"2024-12-03", seller:"kpop_store_tw", url:"https://shopee.tw/...", note:"售後提供授權文件，已確認合法", timeline:[{text:"通報收到",date:"2024-12-03"},{text:"賣家提供合法授權證明",date:"2024-12-05"},{text:"不成立，案件關閉",date:"2024-12-06"}] },
  { id:"RPT-2024-0013", platform:"momo", platformKey:"momo", product:"未申請核准電磁爐（大陸製）", category:"未申報電磁波產品", violations:["非法販售"], status:"done", date:"2024-12-01", seller:"momo_kitchen_life", url:"https://www.momoshop.com.tw/...", note:"無 BSMI 標章", timeline:[{text:"通報收到",date:"2024-12-01"},{text:"確認違規",date:"2024-12-03"},{text:"已下架",date:"2024-12-05"}] },
  { id:"RPT-2024-0012", platform:"蝦皮購物", platformKey:"shopee", product:"壯陽保健膠囊（自稱秘方）", category:"未核准藥品或偽藥", violations:["非法販售","標示不符"], status:"done", date:"2024-11-28", seller:"shop_natural88", url:"https://shopee.tw/...", note:"標榜天然成分但含西藥成分", timeline:[{text:"通報收到",date:"2024-11-28"},{text:"調查中",date:"2024-11-29"},{text:"已通知下架",date:"2024-12-02"}] },
  { id:"RPT-2024-0011", platform:"PChome", platformKey:"pchome", product:"未獲認證安全帽（機車用）", category:"危險玩具（未符 CNS 標準）", violations:["非法販售"], status:"pending", date:"2024-11-26", seller:"pc_moto_parts", url:"https://24h.pchome.com.tw/...", note:"無 CNS 2396 認證，安全疑慮", timeline:[{text:"通報收到，待審核",date:"2024-11-26"}] },
  { id:"RPT-2024-0010", platform:"露天市集", platformKey:"ruten", product:"未核准皮膚美白針", category:"未核准藥品或偽藥", violations:["非法販售","來源不明"], status:"reviewing", date:"2024-11-25", seller:"beauty_ruten_shop", url:"https://www.ruten.com.tw/...", note:"宣稱可快速美白，疑含未核准成分", timeline:[{text:"通報收到",date:"2024-11-25"},{text:"衛生局介入調查",date:"2024-11-27"}] },
  { id:"RPT-2024-0009", platform:"蝦皮購物", platformKey:"shopee", product:"Nike 球鞋（高仿版）", category:"仿冒品 / 侵權商品", violations:["仿冒或侵權"], status:"done", date:"2024-11-22", seller:"shoe_king_tw", url:"https://shopee.tw/...", note:"以正品價格出售明顯仿冒品", timeline:[{text:"通報收到",date:"2024-11-22"},{text:"確認仿冒",date:"2024-11-24"},{text:"下架並停用帳號",date:"2024-11-25"}] },
  { id:"RPT-2024-0008", platform:"Yahoo 購物", platformKey:"yahoo", product:"含砷美白面膜", category:"違規食品添加物", violations:["非法販售","標示不符"], status:"done", date:"2024-11-20", seller:"yahoo_beauty_care", url:"https://tw.buy.yahoo.com/...", note:"衛生局檢驗含重金屬超標", timeline:[{text:"通報收到",date:"2024-11-20"},{text:"衛生局緊急檢驗",date:"2024-11-21"},{text:"確認違規，全面下架",date:"2024-11-23"}] },
  { id:"RPT-2024-0007", platform:"momo", platformKey:"momo", product:"瘦臉神器（高頻電流）", category:"未申報電磁波產品", violations:["非法販售"], status:"reviewing", date:"2024-11-18", seller:"momo_beauty_device", url:"https://www.momoshop.com.tw/...", note:"無醫療器材許可證", timeline:[{text:"通報收到",date:"2024-11-18"},{text:"食藥署調查中",date:"2024-11-20"}] },
  { id:"RPT-2024-0006", platform:"蝦皮購物", platformKey:"shopee", product:"含美沙冬保健品", category:"違禁毒品或管制物質", violations:["非法販售","來源不明"], status:"done", date:"2024-11-15", seller:"health_boost_tw", url:"https://shopee.tw/...", note:"檢驗含管制藥品成分", timeline:[{text:"通報收到",date:"2024-11-15"},{text:"移交檢警調查",date:"2024-11-16"},{text:"已逮捕嫌疑人，案件移送",date:"2024-11-22"}] },
  { id:"RPT-2024-0005", platform:"PChome", platformKey:"pchome", product:"未申報無人機（限飛區域可飛）", category:"未申報電磁波產品", violations:["非法販售"], status:"invalid", date:"2024-11-12", seller:"pc_drone_shop", url:"https://24h.pchome.com.tw/...", note:"調查後確認已申報核准", timeline:[{text:"通報收到",date:"2024-11-12"},{text:"商家提供民航局核准文件",date:"2024-11-14"},{text:"不成立",date:"2024-11-15"}] },
  { id:"RPT-2024-0004", platform:"露天市集", platformKey:"ruten", product:"大麻二酚 CBD 軟糖", category:"違禁毒品或管制物質", violations:["非法販售"], status:"done", date:"2024-11-10", seller:"ruten_natural_store", url:"https://www.ruten.com.tw/...", note:"在台灣屬管制物質", timeline:[{text:"通報收到",date:"2024-11-10"},{text:"確認違規",date:"2024-11-11"},{text:"已下架並移送法辦",date:"2024-11-13"}] },
  { id:"RPT-2024-0003", platform:"蝦皮購物", platformKey:"shopee", product:"小朋友萬聖節面具（含螢光劑）", category:"危險玩具（未符 CNS 標準）", violations:["非法販售","標示不符"], status:"done", date:"2024-11-08", seller:"shop_halloween_tw", url:"https://shopee.tw/...", note:"螢光劑超標", timeline:[{text:"通報收到",date:"2024-11-08"},{text:"商品檢測確認超標",date:"2024-11-10"},{text:"下架處理",date:"2024-11-11"}] },
  { id:"RPT-2024-0002", platform:"momo", platformKey:"momo", product:"未授權動漫周邊商品 X20件", category:"仿冒品 / 侵權商品", violations:["仿冒或侵權"], status:"done", date:"2024-11-05", seller:"momo_anime_shop", url:"https://www.momoshop.com.tw/...", note:"大量侵權商品", timeline:[{text:"通報收到",date:"2024-11-05"},{text:"調查確認侵權",date:"2024-11-07"},{text:"全店下架",date:"2024-11-09"}] },
  { id:"RPT-2024-0001", platform:"蝦皮購物", platformKey:"shopee", product:"含塑化劑嬰兒奶嘴", category:"危險玩具（未符 CNS 標準）", violations:["非法販售","標示不符","逾期或失效商品"], status:"done", date:"2024-11-01", seller:"baby_safe_shop", url:"https://shopee.tw/...", note:"首批通報案件", timeline:[{text:"通報收到",date:"2024-11-01"},{text:"衛生局檢驗",date:"2024-11-03"},{text:"確認超標，要求下架並回收",date:"2024-11-05"}] },
];

const PLATFORM_COLORS = {
  shopee: { bg:"#ee4d2d", text:"#fff", label:"蝦皮" },
  pchome: { bg:"#c00", text:"#fff", label:"PCH" },
  momo:   { bg:"#d5004b", text:"#fff", label:"momo" },
  ruten:  { bg:"#0055a5", text:"#fff", label:"露天" },
  yahoo:  { bg:"#7b0099", text:"#fff", label:"Yahoo" },
};

const STATUS_MAP = {
  done:      { label:"已處理", cls:"status-done" },
  reviewing: { label:"審核中", cls:"status-reviewing" },
  pending:   { label:"待審核", cls:"status-pending" },
  invalid:   { label:"不成立", cls:"status-invalid" },
};

// ── LocalStorage helpers ──
function loadRecords() {
  try {
    const saved = localStorage.getItem('rpt_records');
    const userRecords = saved ? JSON.parse(saved) : [];
    // Prepend user-submitted records before the base set
    return [...userRecords, ...BASE_RECORDS];
  } catch(e) { return [...BASE_RECORDS]; }
}

function saveRecord(record) {
  try {
    const saved = localStorage.getItem('rpt_records');
    const existing = saved ? JSON.parse(saved) : [];
    existing.unshift(record);
    localStorage.setItem('rpt_records', JSON.stringify(existing));
  } catch(e) { /* storage unavailable */ }
}

// The live working dataset (base + any user-submitted)
let MOCK_RECORDS = loadRecords();

// ─────────────────────────────────
// 2. PAGE NAVIGATION
// ─────────────────────────────────
function showPage(p) {
  document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
  document.getElementById('page-'+p).classList.add('active');

  document.querySelectorAll('.nav-links a').forEach(el => el.classList.remove('active'));
  const navEl = document.getElementById('nav-'+p);
  if(navEl) navEl.classList.add('active');

  document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
  const tabEl = document.getElementById('tab-'+p);
  if(tabEl) tabEl.classList.add('active');

  if(p === 'history') { MOCK_RECORDS = loadRecords(); filterRecords(); }
  if(p === 'stats')   { MOCK_RECORDS = loadRecords(); updateStats(); initCharts(); }
}

// ─────────────────────────────────
// 3. PLATFORM DETECTION
// ─────────────────────────────────
function detectPlatform(url) {
  const map = [
    {key:'shopee',  name:'蝦皮購物 Shopee', domains:['shopee.tw']},
    {key:'pchome',  name:'PChome 24h',      domains:['pchome.com.tw','24h.pchome.com.tw']},
    {key:'momo',    name:'momo 購物網',      domains:['momoshop.com.tw']},
    {key:'ruten',   name:'露天市集',          domains:['ruten.com.tw']},
    {key:'yahoo',   name:'Yahoo 購物',        domains:['buy.yahoo.com','tw.buy.yahoo.com']},
    {key:'rakuten', name:'樂天市場',          domains:['rakuten.com.tw']},
  ];
  const matched = map.find(p => p.domains.some(d => url.includes(d)));
  const preview = document.getElementById('platform-preview');
  if(matched) {
    document.getElementById('detected-platform').textContent = matched.key.toUpperCase();
    document.getElementById('detected-name').textContent = matched.name;
    document.getElementById('platform-select').value = matched.key;
    preview.classList.add('show');
  } else {
    preview.classList.remove('show');
  }
}

// ─────────────────────────────────
// 5. IMAGE PREVIEW WITH DELETE
// ─────────────────────────────────
let uploadedFiles = [];

function previewFiles(input) {
  const newFiles = Array.from(input.files);
  const remaining = 3 - uploadedFiles.length;
  const toAdd = newFiles.slice(0, remaining);
  uploadedFiles = [...uploadedFiles, ...toAdd];
  renderPreviews();
  // Reset input so same file can be re-added if deleted
  input.value = '';
}

function renderPreviews() {
  const container = document.getElementById('preview-container');
  container.innerHTML = '';
  uploadedFiles.forEach((file, idx) => {
    const reader = new FileReader();
    reader.onload = e => {
      const wrap = document.createElement('div');
      wrap.className = 'preview-item';

      const img = document.createElement('img');
      img.src = e.target.result;

      const del = document.createElement('button');
      del.className = 'preview-delete';
      del.innerHTML = '<i class="fas fa-xmark"></i>';
      del.title = '移除此圖片';
      del.onclick = (ev) => {
        ev.stopPropagation();
        uploadedFiles.splice(idx, 1);
        renderPreviews();
      };

      wrap.appendChild(img);
      wrap.appendChild(del);
      container.appendChild(wrap);
    };
    reader.readAsDataURL(file);
  });
}

// ─────────────────────────────────
// 6. STEP NAVIGATION
// ─────────────────────────────────
function goStep2() {
  const url  = document.getElementById('product-url').value.trim();
  const name = document.getElementById('product-name').value.trim();
  const cat  = document.getElementById('category-select').value;
  const plat = document.getElementById('platform-select').value;
  if(!url || !name || !cat || !plat) {
    alert('請填寫所有必填欄位（*）');
    return;
  }
  const platName = document.getElementById('platform-select').selectedOptions[0].text;
  document.getElementById('confirm-content').innerHTML = `
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
      <div><div style="font-size:11px;color:var(--text-secondary);margin-bottom:4px">電商平台</div><div style="font-size:14px;font-weight:700">${platName}</div></div>
      <div><div style="font-size:11px;color:var(--text-secondary);margin-bottom:4px">禁售類別</div><div style="font-size:14px;font-weight:700">${cat}</div></div>
      <div style="grid-column:1/-1"><div style="font-size:11px;color:var(--text-secondary);margin-bottom:4px">商品名稱</div><div style="font-size:14px;font-weight:700">${name}</div></div>
      <div style="grid-column:1/-1"><div style="font-size:11px;color:var(--text-secondary);margin-bottom:4px">商品連結</div><div style="font-size:12px;color:var(--amber);word-break:break-all">${url}</div></div>
    </div>
  `;
  document.getElementById('form-step1').classList.remove('active');
  document.getElementById('form-step2').classList.add('active');
  document.getElementById('step1-indicator').classList.remove('active');
  document.getElementById('step1-indicator').classList.add('done');
  document.getElementById('step2-indicator').classList.add('active');
}

function goStep1() {
  document.getElementById('form-step2').classList.remove('active');
  document.getElementById('form-step1').classList.add('active');
  document.getElementById('step1-indicator').classList.add('active');
  document.getElementById('step1-indicator').classList.remove('done');
  document.getElementById('step2-indicator').classList.remove('active');
}

// ─────────────────────────────────
// 7. SUBMIT WITH LOADING EFFECT
// ─────────────────────────────────
function submitReport() {
  const btnSubmit = document.getElementById('btn-submit');
  const btnBack   = document.getElementById('btn-back');

  // Loading state
  btnSubmit.disabled = true;
  btnBack.disabled   = true;
  btnSubmit.innerHTML = '<i class="fas fa-circle-notch fa-spin-custom"></i> 送出中...';

  // Collect form values for saving
  const url      = document.getElementById('product-url').value.trim();
  const name     = document.getElementById('product-name').value.trim();
  const cat      = document.getElementById('category-select').value;
  const platVal  = document.getElementById('platform-select').value;
  const platName = document.getElementById('platform-select').selectedOptions[0].text.split(' ')[0];
  const seller   = document.getElementById('seller-id').value.trim() || '—';
  const note     = document.getElementById('note-field').value.trim() || '（無補充說明）';
  const violations = Array.from(document.querySelectorAll('.violation-cb:checked')).map(el => el.parentElement.textContent.trim());
  const today = new Date().toISOString().slice(0,10);
  const newId = 'RPT-' + new Date().getFullYear() + '-' + String(Math.floor(Math.random()*900)+100).padStart(4,'0');

  const newRecord = {
    id: newId,
    platform: platName,
    platformKey: platVal,
    product: name,
    category: cat,
    violations: violations.length ? violations : ['非法販售'],
    status: 'pending',
    date: today,
    seller: seller,
    url: url,
    note: note,
    timeline: [{ text:'通報收到，等待審核', date: today }],
    isNew: true,
  };

  // Simulate 1.5s API call delay
  setTimeout(() => {
    // Persist to localStorage
    saveRecord(newRecord);
    MOCK_RECORDS = loadRecords();

    // Update UI
    document.getElementById('report-id-display').textContent = newId;
    document.getElementById('form-step2').classList.remove('active');
    document.getElementById('form-success').classList.add('active');
    document.getElementById('step2-indicator').classList.remove('active');
    document.getElementById('step2-indicator').classList.add('done');

    // Reset button state (for next use)
    btnSubmit.disabled = false;
    btnBack.disabled   = false;
    btnSubmit.innerHTML = '<i class="fas fa-paper-plane"></i> 確認送出通報';
  }, 1500);
}

function copyId() {
  const id = document.getElementById('report-id-display').textContent;
  navigator.clipboard.writeText(id).then(() => alert('已複製通報編號：' + id));
}

// ─────────────────────────────────
// 8. DYNAMIC FILTERING (History)
// ─────────────────────────────────
function filterRecords() {
  const keyword  = (document.getElementById('filter-search')?.value || '').trim().toLowerCase();
  const platform = document.getElementById('filter-platform')?.value || '';
  const category = document.getElementById('filter-category')?.value || '';
  const status   = document.getElementById('filter-status')?.value || '';

  const filtered = MOCK_RECORDS.filter(r => {
    const matchKeyword  = !keyword  || r.product.toLowerCase().includes(keyword) || r.seller.toLowerCase().includes(keyword) || r.id.toLowerCase().includes(keyword);
    const matchPlatform = !platform || r.platform.includes(platform);
    const matchCategory = !category || r.category.includes(category);
    const matchStatus   = !status   || r.status === status;
    return matchKeyword && matchPlatform && matchCategory && matchStatus;
  });

  renderRecords(filtered);
}

// ─────────────────────────────────
// 9. RENDER RECORDS
// ─────────────────────────────────
function renderRecords(records) {
  const list = document.getElementById('records-list');
  document.getElementById('records-count-num').textContent = records.length;

  if(records.length === 0) {
    list.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-magnifying-glass"></i>
        <p>沒有符合條件的通報紀錄</p>
      </div>`;
    return;
  }

  list.innerHTML = records.map(r => {
    const pc = PLATFORM_COLORS[r.platformKey] || {bg:'#555',text:'#fff',label:'?'};
    const st = STATUS_MAP[r.status];
    const tl = r.timeline.map((t,i) => `
      <div class="timeline-item">
        <div class="timeline-dot" style="${i===r.timeline.length-1?'background:var(--amber)':'background:var(--gray-muted)'}"></div>
        <div><div class="timeline-text">${t.text}</div><div class="timeline-date">${t.date}</div></div>
      </div>
    `).join('');
    const newBadge = r.isNew ? `<span style="background:rgba(245,166,35,0.15);color:var(--amber);font-size:10px;padding:2px 8px;border-radius:4px;font-weight:700;margin-left:6px">NEW</span>` : '';
    return `
    <div class="record-card" onclick="toggleRecord(this)">
      <div class="record-header">
        <div class="platform-dot" style="background:${pc.bg};color:${pc.text}">${pc.label}</div>
        <div class="record-main">
          <div class="record-title">${r.product}${newBadge}</div>
          <div class="record-meta">
            <span class="meta-tag"><i class="fas fa-store"></i>${r.platform}</span>
            <span class="meta-tag"><i class="fas fa-tag"></i>${r.category}</span>
            <span class="meta-tag"><i class="fas fa-calendar"></i>${r.date}</span>
            <span class="meta-tag" style="font-family:'Space Mono',monospace;font-size:10px">${r.id}</span>
          </div>
        </div>
        <span class="status-badge ${st.cls}">${st.label}</span>
        <i class="fas fa-chevron-down record-chevron"></i>
      </div>
      <div class="record-detail">
        <div class="detail-grid">
          <div class="detail-item"><label>賣家 ID</label><span>${r.seller}</span></div>
          <div class="detail-item"><label>違規樣態</label><span>${r.violations.join('、')}</span></div>
          <div class="detail-item full" style="grid-column:1/-1"><label>商品連結</label><a class="detail-link" href="#">${r.url}</a></div>
          <div class="detail-item full" style="grid-column:1/-1"><label>補充說明</label><span>${r.note}</span></div>
        </div>
        <div class="timeline">
          <div class="timeline-title"><i class="fas fa-timeline"></i> 處理進度</div>
          ${tl}
        </div>
      </div>
    </div>`;
  }).join('');
}

function toggleRecord(el) {
  el.classList.toggle('expanded');
}

// ─────────────────────────────────
// 10. DYNAMIC STATS
// ─────────────────────────────────
function updateStats() {
  const total     = MOCK_RECORDS.length;
  const done      = MOCK_RECORDS.filter(r => r.status === 'done').length;
  const reviewing = MOCK_RECORDS.filter(r => r.status === 'reviewing').length;
  const rate      = total > 0 ? ((done / total) * 100).toFixed(1) : '0.0';

  const statTotal     = document.getElementById('stat-total');
  const statDone      = document.getElementById('stat-done');
  const statReviewing = document.getElementById('stat-reviewing');
  const statRate      = document.getElementById('stat-rate');

  if(statTotal)     statTotal.textContent     = total;
  if(statDone)      statDone.textContent      = done;
  if(statReviewing) statReviewing.textContent = reviewing;
  if(statRate)      statRate.textContent      = rate;
}

// ─────────────────────────────────
// 11. CHARTS
// ─────────────────────────────────
let chartsInit = false;
function initCharts() {
  if(chartsInit) return;
  chartsInit = true;

  const chartDefaults = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: { legend: { labels: { color:'#8892a4', font:{size:11}, boxWidth:12 } } },
  };
  const amber='#f5a623', green='#2dce89', orange='#fb6340', red='#e84545', blue='#4fc3f7', purple='#ce93d8';

  // Trend
  new Chart(document.getElementById('trendChart'), {
    type:'line',
    data:{
      labels:['7月','8月','9月','10月','11月','12月'],
      datasets:[{
        label:'通報數',
        data:[28,35,31,42,56,56],
        borderColor: amber, backgroundColor:'rgba(245,166,35,0.12)',
        tension:0.4, fill:true, pointBackgroundColor:amber, pointRadius:5,
      }]
    },
    options:{...chartDefaults, scales:{
      x:{ticks:{color:'#8892a4'},grid:{color:'rgba(255,255,255,0.04)'}},
      y:{ticks:{color:'#8892a4'},grid:{color:'rgba(255,255,255,0.06)'},beginAtZero:true},
    }}
  });

  // Platform bar
  new Chart(document.getElementById('platformChart'), {
    type:'bar',
    data:{
      labels:['蝦皮','momo','PChome','露天','Yahoo','樂天'],
      datasets:[{
        label:'通報數',
        data:[98,55,42,28,18,7],
        backgroundColor:[amber, orange, red, blue, purple, green],
        borderRadius:6,
      }]
    },
    options:{...chartDefaults,
      plugins:{...chartDefaults.plugins, legend:{display:false}},
      scales:{
        x:{ticks:{color:'#8892a4'},grid:{display:false}},
        y:{ticks:{color:'#8892a4'},grid:{color:'rgba(255,255,255,0.06)'},beginAtZero:true},
      }
    }
  });

  // Category donut
  new Chart(document.getElementById('categoryChart'), {
    type:'doughnut',
    data:{
      labels:['未核准藥品','仿冒品','違規食品添加物','危險玩具','管制物質','其他'],
      datasets:[{
        data:[88,62,38,31,18,11],
        backgroundColor:[amber,orange,red,blue,purple,green],
        borderColor:'#112240', borderWidth:3,
      }]
    },
    options:{...chartDefaults, cutout:'65%',
      plugins:{...chartDefaults.plugins, legend:{position:'right', labels:{color:'#8892a4',font:{size:11},boxWidth:12}}}
    }
  });

  // Violation stacked
  new Chart(document.getElementById('violationChart'), {
    type:'bar',
    data:{
      labels:['蝦皮','momo','PChome','露天','Yahoo'],
      datasets:[
        {label:'非法販售',    data:[45,25,20,15,10], backgroundColor:amber},
        {label:'標示不符',    data:[22,15,12,8,5],   backgroundColor:orange},
        {label:'仿冒或侵權',  data:[18,10,6,3,2],    backgroundColor:red},
        {label:'來源不明',    data:[9,4,3,2,1],      backgroundColor:blue},
        {label:'逾期商品',    data:[4,1,1,0,0],      backgroundColor:purple},
      ]
    },
    options:{...chartDefaults,
      scales:{
        x:{stacked:true,ticks:{color:'#8892a4'},grid:{display:false}},
        y:{stacked:true,ticks:{color:'#8892a4'},grid:{color:'rgba(255,255,255,0.06)'},beginAtZero:true},
      }
    }
  });
}

// ─── Init ───
filterRecords();
updateStats();
</script>
</body>
</html>
